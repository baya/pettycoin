TEST_SOURCES := $(wildcard test/run-*.c)
TEST_HELPERS := $(wildcard test/helper*.c)
TEST_BINS := $(TEST_SOURCES:.c=)
LDLIBS := -lcrypto -lrt
TEST_HELPER_OBJS := $(TEST_HELPERS:.c=.o)

UNIT_TESTS:=$(TEST_BINS:%=check-%)

default-test:
	@echo Run make check from top dir. >&2 && exit 1

check: unit-check

unit-check: $(UNIT_TESTS)

$(UNIT_TESTS): check-test/%: test/%
	@trap "rm -f unit.$*.out" EXIT; if $(VALGRIND) $(VALGRIND_TEST_ARGS) $< > unit.$*.out 2>&1; then if grep -q 'loss record' unit.$*.out; then printf "[UNIT] %-48s LEAK\n" $*; cat unit.$*.out; exit 1; else printf "[UNIT] %-48s OK\n" $*; exit 0; fi; else printf "[UNIT] %-48s FAIL\n" $*; cat unit.$*.out; exit 1; fi

test-bins: $(TEST_BINS)

update-mocks-test/%: test/%
	@set -e; trap "rm -f mocktmp.$*.*" EXIT; \
	START=`fgrep -n '/* AUTOGENERATED MOCKS START */' $< | cut -d: -f1`;\
	END=`fgrep -n '/* AUTOGENERATED MOCKS END */' $< | cut -d: -f1`; \
	if [ -n "$$START" ]; then \
	  echo $<: ; \
	  head -n $$START $< > mocktmp.$*.new; \
	  (cat mocktmp.$*.new; tail -n +$$END $<) > mocktmp.$*.test.c; \
	  if ! $(CC) $(CFLAGS) -Itest/ mocktmp.$*.test.c -o mocktmp.$*.out $(HELPER_OBJS) $(CCAN_OBJS) $(LDLIBS) 2>mocktmp.$*.err; then \
	    test/mockup.sh < mocktmp.$*.err >> mocktmp.$*.new; \
	    sed -n 's,.*Generated stub for \(.*\) .*,\t\1,p' < mocktmp.$*.new; \
          fi; \
	  tail -n +$$END $< >> mocktmp.$*.new; mv mocktmp.$*.new $<; \
	fi

test/easy_genesis.c: mkgenesis protocol.h block.h
	echo '/* A deliberately easy genesis block for testing. */' > $@
	./mkgenesis 0x1ffffff0 1404886369 'MarcusArabellAlex' | sed 's,#include ",#include "../,' >> $@

$(TEST_SOURCES:%=update-mocks-%): $(CCAN_OBJS) $(TEST_HELPER_OBJS) test/easy_genesis.c ecode_names.c

update-mocks: $(TEST_SOURCES:%=update-mocks-%)

$(TEST_BINS:=.o) : %.o : %.c
	@$(CC) $(CFLAGS) -Itest/ -c -o $@ $<

$(TEST_BINS:=.o): test/easy_genesis.c

$(TEST_BINS) : $(TEST_HELPER_OBJS) $(CCAN_OBJS)

clean: test-clean
distclean: test-distclean

test-clean:
	rm -f $(TEST_BINS) test/*.o

test-distclean:
	$(RM) test/easy_genesis.c


include test/standalone/Makefile
include test/blackbox/Makefile

.PHONY: update-mocks
